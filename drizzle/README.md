# Drizzle Migrations

This directory contains database migrations generated by Drizzle Kit.

## ðŸ“š Documentation

- **[Complete D1 Migrations Guide](./MIGRATIONS.md)** - Comprehensive guide for Cloudflare D1
- **[D1 Example](../example/D1_EXAMPLE.md)** - Working example with D1 Workers

## Quick Start

### Local SQLite

```bash
# Generate migrations
bun run db:generate

# Push schema directly (development only)
bun run db:push

# Open Drizzle Studio
bun run db:studio
```

### Cloudflare D1

```bash
# Set environment variables
export CLOUDFLARE_ACCOUNT_ID="your-account-id"
export CLOUDFLARE_DATABASE_ID="your-database-id"
export CLOUDFLARE_API_TOKEN="your-api-token"

# Generate migrations
bun run db:generate:d1

# Apply migrations
bun run db:migrate:d1

# Open Drizzle Studio for D1
bun run db:studio:d1
```

## Directory Structure

```
drizzle/
â”œâ”€â”€ README.md           # This file
â”œâ”€â”€ MIGRATIONS.md       # Complete D1 migrations guide
â”œâ”€â”€ d1/                 # D1-specific migrations
â”‚   â””â”€â”€ 0000_*.sql
â””â”€â”€ meta/               # Drizzle Kit metadata
    â””â”€â”€ _journal.json
```

## Migration Files

Migrations are generated in `drizzle/d1/` directory with timestamp-based naming:

- `0000_initial_schema.sql` - Initial database schema
- `0001_add_user_status.sql` - Add status column to users
- `0002_create_posts_table.sql` - Create posts table
- etc.

## Apply Migrations Programmatically

For non-D1 environments, you can apply migrations in code:

```typescript
import { Database } from 'bun:sqlite';
import { drizzle } from 'drizzle-orm/bun-sqlite';
import { migrate } from 'drizzle-orm/bun-sqlite/migrator';

const sqlite = new Database('./database.sqlite');
const db = drizzle(sqlite);

// Apply all pending migrations
await migrate(db, { migrationsFolder: './drizzle' });
```

## Common Commands

```bash
# Generate migrations from schema changes
bun run db:generate:d1

# Apply migrations to D1 database
bun run db:migrate:d1

# Push schema directly (skip migrations - dev only!)
bun run db:push:d1

# Open visual database browser
bun run db:studio:d1

# Check D1 database status
wrangler d1 info <database-name>

# Execute SQL on D1
wrangler d1 execute <database-name> --file=./drizzle/d1/0000_*.sql

# Backup D1 database
wrangler d1 export <database-name> --output=backup.sql
```

## Best Practices

1. **Version Control**: Always commit migration files to git
2. **Review Generated SQL**: Check migration files before applying
3. **Test First**: Apply to dev/staging before production
4. **Backup**: Export database before major migrations
5. **Never Edit**: Don't modify generated migration files manually

## Configuration Files

- `drizzle.config.ts` - Local SQLite configuration
- `drizzle.config.d1.ts` - Cloudflare D1 configuration
- `wrangler.toml.example` - Cloudflare Workers configuration template

## Troubleshooting

See the [Complete Migrations Guide](./MIGRATIONS.md#troubleshooting) for detailed troubleshooting steps.

Common issues:

- Authentication errors â†’ Check API token permissions
- "Table exists" errors â†’ Review migration history
- Connection timeouts â†’ Verify account/database IDs

## Resources

- [Drizzle Kit Documentation](https://orm.drizzle.team/kit-docs/overview)
- [Cloudflare D1 Documentation](https://developers.cloudflare.com/d1/)
- [Complete D1 Migrations Guide](./MIGRATIONS.md)
